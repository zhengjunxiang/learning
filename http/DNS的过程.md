# 科普DNS解析过程
为什么需要DNS解析域名为IP地址？

网络通讯大部分是基于TCP/IP的，而TCP/IP是基于IP地址的，所以计算机在网络上进行通讯时只能识别如“202.96.134.133”之类的IP地址，而不能认识域名。DNS是应用层协议，事实上他是为其他应用层协议工作的，包括不限于HTTP和SMTP以及FTP，用于将用户提供的主机名解析为ip地址。
```
1.浏览器会检查缓存中有没有域名对应的ip地址，这个缓存是有过期时长的，一般是几分钟到几小时不等。

2.如果浏览器缓存没有，那么就检查操作系统的hosts文件

3.如果本地也没有配置那么就会根据向本机配置的本地区DNS域名服务器（LDNS）发起请求，如果你是通过学校连接互联网的一般是你学校的DNS服务器，如果你是在小区连接互联网的一般是网络提供商比如电信，联通的DNS服务器，DNS服务器通常不会太远。如何查看本机的域名服务器，在Linux可以通过 cat /etc/resolv.conf查看。到这一步基本能解析80%的域名

4.如果LDNS也不能解析，那么就直接到根域名服务器请求解析。如果未用转发模式，本地DNS就把请求发至13台根DNS。

5.根域名服务器会给本地域名服务器LDNS一个所查询的主域名服务器（gTLD）地址，gTLD是国际顶级域名服务器，比如.com,.cn,.org等。根DNS服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(http://qq.com)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找http://qq.com域服务器，重复上面的动作，进行查询，直至找到www  . qq  .com主机。

6.如果用的是转发模式，本地DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS服务器或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是直接请求根DNS服务器，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。

7.本地域名服务器LDNS再向上一步返回的gLTD服务器发送请求。

8.gLTD服务器查询并返回域名对应的Name Server域名服务器的地址，通常是你注册的域名服务器，例如你在某个域名服务器提供商申请的域名，那么这个域名解析任务就由这个域名服务提供商来完成。

8.Name Server域名服务器会查询存储的域名和ip的映射关系表，将ip连同一个TTL值返回给DNS Server域名服务器。

9.LDNS拿到ip和TTL会缓存起来，缓存时间由TTL值控制。

10.把解析的结果返回给用户，用户根据TTL值缓存在本地系统缓存中，域名解析过程结束。入Name Server也有可能有多级或者一个GTM来控制负载均衡，都能影响DNS解析过程。
```

1.浏览器 会从自身的 缓存中 查询是否存在对应域名的 IP 地址，若存在返回，若不存在进入下一步
2.客户机查询操作系统中的 /etc/hosts 文件中查询是否有对应域名的 IP 地址，若存在则返回，若不存在进入下一步
3.客户机请求 本地域名服务器（LDNS） 进行解析，本地域名服务器收到客户机的请求后，4.先查询自己的缓存信息是否有对应域名的 IP 地址，若存在返回结果，没有则进行下一步
5.本地域名服务器请求 根域名服务器 解析该域名，根域名告诉本地域名服务器去找对应的 一级域名服务器
6.本地域名服务器请求一级域名服务器解析这个域名，一级域名服务器告诉它去找对应的 二级域名服务器
7.本地域名服务器请求二级域名服务器解析这个域名，二级域名服务器告诉它去找对应的 子域名服务器
8.本地域名服务器请求子域名服务器解析这个域名，子域名服务器返回对应的 IP 地址
本地域名服务器将 IP 地址记录到缓存中，并返回给客户机（会缓存起来），客户机根据收到的 IP 地址访问该网站

[dns查询流程图](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfc3072677f44c88ba2f098f8dd5dc5b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

递归查询 主机向本地域名服务器的查询

迭代查询 本地域名服务器向根域名服务器的查询

# 什么是DNS劫持

DNS劫持即通过某种技术手段，篡改正确域名和IP地址的映射关系，使得域名映射到了错误的IP地址，因此可以认为DNS劫持是一种DNS重定向攻击。DNS劫持通常可被用作域名欺诈，如在用户访问网页时显示额外的信息来赚取收入等；也可被用作网络钓鱼，如显示用户访问的虚假网站版本并非法窃取用户的个人信息。

【一、本地DNS劫持】
客户端侧发生的DNS劫持统称为本地DNS劫持。本地DNS劫持可能是：

黑客通过木马病毒或者恶意程序入侵PC，篡改DNS配置(hosts文件，DNS服务器地址，DNS缓存等)。
黑客利用路由器漏洞或者破击路由器管理账号入侵路由器并且篡改DNS配置。
一些企业代理设备（如Cisco Umbrella intelligent proxy）针对企业内部场景对一些特定的域名做DNS劫持解析为指定的结果。

【二、DNS解析路径劫持】DNS请求转发 DNS请求复制

# DNS解析是基于UDP的，因为不需要建立链接浪费时间，时效性比较好

TCP通信过程太复杂并且开销大，一次TCP交换需要9个包： 三个连接包，四个断开包，一个request包，一个响应包。

UDP通信过程简单，只需要一个查询包和一个响应包。

# 权威服务器
COM顶级服务器可以授权xxorg.com这个域名的的权威服务器为NS.ABC.COM

# 递归DNS
递归DNS又称为Local DNS，它没有域名解析结果的决定权，但代理了用户向权威DNS获取域名解析结果的过程。递归DNS上有缓存模块，当目标域名存在缓存解析结果并且TTL未过期时（每个域名都有TTL时间，即有效生存时间，若域名解析结果缓存的时间超过TTL，需要重新向权威DNS获取解析结果），递归DNS会返回缓存结果，否则，递归DNS会一级一级地查询各个层级域名的权威DNS直至获取最终完整域名的解析结果。eg: 我们自己的电脑，运营商提供的dns服务器等等。

# 公共DNS
公共DNS是递归DNS的一种特例，它是一种全网开放的递归DNS服务，而传统的递归DNS信息一般由运营商分发给用户。

# 转发DNS
可以理解为递归DNS和用户之间的一个中转站，它不提供直接解析域名的服务，它将请求转发给递归DNS，然后将递归DNS的结果转发一下，也提供缓存作用。比如，日常家用的路由器，它的DNS服务器一般都是192.168.1.1，只是转发给递归DNS。
